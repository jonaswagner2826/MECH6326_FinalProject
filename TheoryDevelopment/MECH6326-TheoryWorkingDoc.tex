% Standard Article Definition
\documentclass[9pt, onecolumn]{report}

% Page Formatting
\usepackage[margin=1in]{geometry}

% \setlength\parindent{0pt}
% \pagestyle{fancy}

% Graphics
\usepackage{graphicx}
\usepackage{xcolor}

% Math Packages
\usepackage{physics}
\usepackage{amsmath, amsfonts, amssymb, amsthm}
\usepackage{mathtools}

% Extra Packages
% \usepackage{pdfpages}
% \usepackage{hyperref}
\usepackage{todonotes}
% \usepackage{listings}

%Custom Commands
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\Q}{\mathbb{Q}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\C}{\mathbb{C}}

% \newcommand{\SigAlg}{\mathcal{S}}

% \newcommand{\Rel}{\mathcal{R}}

% \newcommand{\toI}{\xrightarrow{\textsf{\tiny I}}}
% \newcommand{\toS}{\xrightarrow{\textsf{\tiny S}}}
% \newcommand{\toB}{\xrightarrow{\textsf{\tiny B}}}

% \newcommand{\divisible}{ \ \vdots \ }
\newcommand{\st}{\ : \ }

% % Theorem Definition
% \newtheorem{definition}{Definition}
% \newtheorem{assumption}{Assumption}
% \newtheorem{theorem}{Theorem}
% \newtheorem{lemma}{Lemma}
% \newtheorem{proposition}{Proposition}
% \newtheorem{remark}{Remark}
% % \newtheorem{example}{Example}
% % \newtheorem{counterExample}{Counter Example}


%opening
\title{
    MECH 6326 - Optimal Control and Dynamic Programming \\ 
    Final Project Working Doc
}
\author{Alyssa Vellucci and Jonas Wagner}
% \date{2023, February 24\textsuperscript{th}}

\begin{document}

\maketitle

% \section{Proposal Things}
% \section*{D\&D Explanation}
% The multi-step decision making under uncertainty problem we will be analyzing is that of combat during a tabletop roleplaying game (TTRPG), specifically a combat encounter under the ruleset from Dungeons \& Dragons fifth edition (D\&D 5e).

% D\&D consists of a group or party of players who go on an adventure together.
% The party is composed of multiple playable characters (PCs) that exist within an environment overseen by a Dungeon Master (DM).
% In a typical D\&D combat, the players will fight a creature (or multiple creatures) being controlled by the DM. 
% The players have certain skills their characters can use, and their effectiveness is determined by a dice roll. 
% The creatures overseen by the DM also have certain skills or tactics they can use against the players, and that efficacy is also determined by a dice roll; however the outcomes of these rolls are hidden from the players. 
% % Simplistically this process can be modeling as a closed loop system where the current state of the battle can be used to inform the player's decision-making and ideally used for a successful combat encounter.

% \section*{System Model}
% The combat encounter will be simplified to fit the scope of the project, but the full combat system is very well documented in the D\&D 5e ruleset; thus, the system is simplistically defined as the environment the combat takes place in. The PCs act as controllers in this environment. All rules governing the actions of the players, enemies, and environment are dictated by the D\&D 5e ruleset. 

% \subsection*{System States:}
% The states of the system include the following for both the PC and enemy creature: 
% (i) hit points (HP), 
% (ii) position within the environment, 
% (iii) condition modifiers (ex. Blinded, prone, poisoned, etc.),
% and (iv) potentially the spell slots remaining (how many times a PC or creature can perform an ability).

% \subsection*{System Inputs:}
% The control inputs would include all the actions the PCs perform.
% This can include a PC conducting an attack, moving a set distance, casting a utility spell, or interacting with an object in their environment. 
% This will be simplified to selecting between a finite number possible actions (melee/ranged attack, cast attack/utility spell, etc.), alongside deciding if and where to move, and potentially another selection between the more restrictive bonus actions. Each action should further the goal of the performance objective.

% \subsection*{Stochastic Disturbances:}
% The stochastic uncertainty within the system comes from the dice rolls made when performing an action.
% Generally a threshold must be met to yield a success along and additional dice rolls to determine effectiveness (i.e. damage) of an action.
% Each roll is also be modified by the specific attributes of the PCs and creatures.

% Since the players don't directly know the stats (armor class, HP totals, what abilities they can use, resistances and weaknesses, etc.) of the enemies they face, additional dice rolls may be taken to determine how effectively the enemies stats are known.
% The initial simplification will eliminate this uncertainty.

% \section*{Primary Control Objective:}
% The primary control objectives of both the PCs and creatures will be to maximize their own HP while minimizing the opponent's HP.
% The objective could also be modified to work with other members of the party, environmental considerations (dangerous/advantageous terrain/formation etc.), and/or increase/decrease the overall length of the encounter.

% \section*{Potential Results:}
% The potential results of this analysis would be the ideal order of actions a player would take to have the optimal combat encounter. This could be displayed as a trajectory of the HP totals of the PCs and the creatures at each time step (combat round). With these graphs, we could directly compare control laws with different parameters (conditions affecting PCs, movement penalties, etc.) and the cost function could also be modified and compared for different scenarios: shortest combat encounter, a chase/fleeing combat encounter, or a protect-the-NPC encounter.

% Another result of the problem could involve a 1D or 2D visualization of the PC and creature movement as it evolves over the course of the combat. The movement mechanic is important in D\&D combat, and rarely do two combatants stand in front of one another the entire encounter.

\chapter{Simple System Model}
\section{System Definition}
\subsection{Assumptions:}
\begin{itemize}
    \item Movement: Single movement per turn
    \begin{itemize}
        \item Deterministic
        \item 1 square movement
        \item move then action
    \end{itemize}
    \item Actions: Single action per time step
    \begin{itemize}
        \item Melee (hit check)(d6) - Short range
        \item Ranged (hit check)(d8) - Longer range
        \item Health Potion (d4 + 1)
        \item Nothing
    \end{itemize}
    \item Characters
    \begin{itemize}
        \item 1 PC and 1 Monster
        \item Identical Specs/modifiers
        \item Same weapon (+2)
    \end{itemize}
    \item Monster
    \begin{itemize}
        \item Monster move in standard pattern
        \item Monster cannot heal
    \end{itemize}
    \item Infinite Time Horizon
    \item Infinite Battlefield and no Obstacles
\end{itemize}

\subsection{Environment Definition}
\subsubsection{States}
Let each character be associated with position and HP states.
For position, let \[
    x_{pc,p}, x_{mn,p} \in \mathcal{X}_{p} \subseteq \Z^{2}
\] describe the position on an infinite 2-d grid.
For HP, let \[
    x_{pc,hp}, x_{mn,hp} \in \mathcal{X}_{hp} \subseteq \Z_+ = \{0, 1, 2, \dots\}
\] describe the HP for each character.

\subsubsection{Inputs}
The inputs to the system consist of movement and actions impacting the position and hp states respectively.
For movement, a deterministic input of 
\begin{multline}
    u_{pc,m}, u_{mn,m} \in \mathcal{U}_{m} = \text{\{N, E, S, W, NE, NW, SE, SW\}}\\
    =\{(-1,0), (+1,0), (0,-1),(0,+1), (-1,-1), (-1,+1), (+1,-1),(+1,+1)\}
\end{multline}

For actions, all the actions (except nothing) each are stochastic and can be represented as Markov chains or as a combination of input and noise term, $u_{pc,a}, u_{mn,a} \in \mathcal{U}_{a} = \{\text{Melee, Ranged, Heal, Nothing}\}$.

For Melee and Ranged attacks, the character acts upon another character's HP where the impact on HP is as follows:
\begin{enumerate}
    \item Ensure in range for either melee or ranged attack - otherwise can't attack.
    \item ``Roll'' for success/fail - if fail then self-loop on opponent HP
    \item ``Roll'' for effectiveness - opponent HP decreased by Weapon/self Modifiers (2) + d6/d8
\end{enumerate}

The PC is allowed to use a health potion which has a stochastic effect upon the player's health:
\begin{enumerate}
    \item Ensure potion is available - otherwise can't heal
    \item ``Roll'' for effectiveness - player's HP increased by health modifier (1) + d4
\end{enumerate}

\subsubsection{Noise}
When written in some forms the stochastic aspects of the system can be described as a noise signal.
This can be modeled as either a single HP update amount with dependent distribution on action or as a non-addative noise signal where the update is dependent as described. 

For a complete picture, let the action noise be described as \[
    w_{pc,a}, w_{mn,a} \in \mathcal{W}_{a} \subseteq \{\text{``success''} = 1, \text{``failure''} = 0\} \cross \Z_{+}
\] where the distributions of each are dependent on the input action $u_{pc,a}, u_{mn,a}$ and associated attack modifiers.

Alternativly for the simplistic case this can be done separately, where $\{\text{``success'', ``failure''}\}$ is dependent on the PC and monster's stats as well as their respective dice rolls, thus \[
    w_{pc,sf}, w_{mn,sf} \in \mathcal{W}_{sf} \subseteq \{0, 1\}
\] and where $w_{pc,sf}$ and $w_{mn,sf}$ are directly calculated from PC and monster modifiers and a d20 role.
The damage or heal amount is then also stochastic dependent on player stats and also dependent on modifiers and a dice roll (d4/d6/d8).

The dice roll noise is defined for dice \{d2, d4, d6, d8, d10, d20, d100\} as 
\[
    w_{pc,dn}, w_{mn,dn} \in \mathcal{W}_{dn} = \{1,2,\dots,n\}
\] with $n = 2,4,6,8,10,20,100$ respectively and each outcome is equally likely.
The PDF {\color{red} PMF?} can be seen in shorthand with $P(w_{i,dn} = \smqty[1 & \cdots & n]^T) = \frac{1}{n}\smqty[1 & \cdots & 1]^T$

\subsection{Problem Statement}
For the simplistic case, let states at time-step $k$, be \[
    x_k = \mqty[x_{pc,p}\\x_{mn,p}\\x_{pc,hp}\\x_{mn,hp}\\ x_{pc,potion}] \in \mathcal{X} = \mathcal{X}_p^2 \cross \mathcal{X}_{hp}^2 \subseteq \Z^{4} \cross \Z_{+}^{2} \cross \Z_{+}
\] where states and sets are defined as before and $x_{pc,potion}$ is the number of potions available to the PC.

Let the inputs to the system be only the players inputs \[
    u_k = \mqty[u_{pc,m}\\u_{pc,a}] \in \mathcal{U} = \mathcal{U}_{p} \cross \mathcal{U}_{a} %\subseteq \{(-1,0), (+1,0), (0,-1),(0,+1), {\color{red} (-1,-1), (-1,+1), (+1,-1),(+1,+1)}\} \cross \{\text{Melee, Ranged, Heal, Nothing}\}
\] The monster's inputs to the system will be incorporated as a deterministic input that and stochastic input that are closed-loop within the system and treated as part of the nonlinear aspects of the update function/Markov chains.

Let the stochastic input signal $w_k$ for each time-step be defined as a collection of all the dice rolls \[
    w_k = \mqty[w_{pc} \\ w_{mn}], \quad w_{i} = \mqty[w_{i,4} \\ w_{i,6} \\ w_{i,8} \\ w_{i,20}] \forall_{i = pc,mn}
    % \mqty[w_{pc,sf}\\w_{pc,d4}\\w_{pc,d6}\\w_{pc,d}\\w_{mn,sf}\\w_{mn,d4}\\w_{mn,d6}\\w_{mn,d8}]
\] and the associated success/fail noise $\forall_{i=pc,mn}$ be derived as \[
    w_{i,sf} = \begin{cases}
        0 & ({\color{red} 5} + w_{i,d20} < {\color{red} 15} \text{ OR } w_{i,d20} = 1) \text{ AND } w_{i,d20} \neq 1\\
        1 & ({\color{red} 5} + w_{i,d20} \geq {\color{red} 15} \text{ OR } w_{i,d20} = 20) \text{ AND } w_{i,d20} \neq 1\\
    \end{cases}
\] \todo{define modifiers as a constant...}
This results in probabilities of 
$P(w_{i,sf} = 0) = (P(w_{i,d20} = 1) + P({\color{red} 5} + w_{i,d20} < {\color{red} 15})) - (P(w_{i,d20} = 20)) = 1/20 + 9/20 - 1/20 = 9/20$ 
and 
$P(w_{i,sf} = 1) = (P(w_{i,d20} = 20) + P({\color{red} 5} + w_{i,d20} \geq {\color{red} 15})) - (P(w_{i,d20} = 1)) = 1/20 + 11/20 - 1/20 = 11/20$.
In shorthand, $P(w_{i,sf}=\smqty[0\\1]) = \smqty[0.45\\0.55]$.

The evolution of the very simple system can be described as Markov chains or by a nonlinear update function:\[
    x_{k+1} = f(x_k, u_k, w_k) 
    % = \mqty[x_{pc,p}\\ x_{mn,p}\\ x_{pc,hp}\\ x_{mn,hp}]_{k+1}
    % = \mqty[f_{pc,m}(x_k,u_k)\\f_{mn,m}(x_k)\\ f_{pc,a}()]
    = \mqty[
        x_{pc,p} + f_{pc,m}(u_k)\\
        % f_{pc,m}(x_k, u_k)\\
        x_{mn,p} + f_{mn,m}(x_k)\\
        % f_{mn,m}(x_k)\\
        \mqty[x_{pc,hp}\\ x_{mn,hp} \\ x_{pc,potion}] + f_{pc,a}(x_k,u_k,w_k) + f_{mn,a}(x_k,w_k)
        % f_{pc,a}(x_k,u_k,w_k) + f_{mn,a}(x_k,w_k)
        % f_{pc,a}(x_k,u_k,w_k)\\
        % f_{mn,a}(x_k,u_k,w_k)
    ]
\] where the associated functions update states as follows: 
\begin{itemize}
    \item The players deterministic movement input: $f_{pc,m}(u_k) = u_{pc,m}$
    \item The monsters state-dependent movement:\[
        f_{mn,m}(x_k) = \operatorname{direction}(x_{pc,p} - x_{mn,p})
    \] where $\operatorname{direction}()$ is calculated as the closest cardinal direction that heads towards the player. (In matlab we do: \verb!round(k_mn_speed * normalize(x_pc_p-x_mn_p))!)
    % $f_{mn,m}(x_k) = (1,1)$ 
    \item The players action:\[
        f_{pc,a} = \begin{cases}
            % \mqty[x_{pc,hp} \\ x_{mn,hp}-w_{pc,sf}(2 + w_{pc,d6})] & u_{pc,a} = \text{Melee} \text{ AND } \norm{x_{pc,p} - x_{mn,p}} \leq \text{Melee Range}\\
            % \mqty[x_{pc,hp} \\ x_{mn,hp}-w_{pc,sf}(2 + w_{pc,d8})] & u_{pc,a} = \text{Ranged} \text{ AND } \norm{x_{pc,p} - x_{mn,p}} \leq \text{Ranged Range}\\
            % \mqty[x_{pc,hp} + 1 + w_{pc,d4} \\ x_{mn,hp}] & u_{pc,a} = \text{Heal} \text{ AND } \text{Have Potion}\\
            % \mqty[x_{pc,hp} \\ x_{mn,hp}] & u_{pc,a} = \text{Nothing} \text{ OR } \text{Otherwise}
            \mqty[0 & -w_{pc,sf}({\color{red}2} + w_{pc,d6}) & 0]^T & u_{pc,a} = \text{Melee} \text{ AND } \norm{x_{pc,p} - x_{mn,p}}_1 \leq \text{Melee Range}\\
            \mqty[0 & -w_{pc,sf}({\color{red}2} + w_{pc,d8}) & 0]^T & u_{pc,a} = \text{Ranged} \text{ AND } \norm{x_{pc,p} - x_{mn,p}}_1 \leq \text{Ranged Range}\\
            \mqty[{\color{red}1} + w_{pc,d4} & 0 & -1]^T & u_{pc,a} = \text{Heal} \text{ AND } x_{pc,potion} \geq 1\\%\text{Have Potion}\\
            \mqty[0 & 0 & 0] & u_{pc,a} = \text{Nothing} \text{ OR } \text{Otherwise}
        \end{cases}
    \]
    \item The monsters state dependent action: \[
        f_{pc,a} = \begin{cases}
            \mqty[-w_{mn,sf}({\color{red}2} + w_{mn,d6}) & 0 & 0]^T & \norm{x_{pc,p} - x_{mn,p}}_1 \leq \text{Melee Range}\\
            \mqty[- w_{mn,sf}({\color{red}2} + w_{mn,d8}) & 0 & 0]^T & \text{Melee Range} < \norm{x_{pc,p} - x_{mn,p}}_1 \leq \text{Ranged Range}\\
            \mqty[0 & 0 & 0]^T & \text{Ranged Range} < \norm{x_{pc,p} - x_{mn,p}}_1
            % [0, 1 + w_{mn,d4}] & u_{mn,a} = \text{Heal} \land \text{Have Potion} \todo{extra state?}\\
            % [0, 0] & u_{mn,a} = \text{Nothing} \lor \text{Otherwise}
        \end{cases}
    \]
\end{itemize}

The objective function and such is yet to be fully defined, but will consist of minimizing the monsters HP and maintaining the PC HP while also finding a way to minimize the time it takes to kill the monster.

\subsection{Markov Implementation}
For each of the stochastic functions defined in the update functions from the problem definition a markov chain can be described to better represent the changes between different states.
Considering that only the actions are stochastic, the chains can be restricted to only the PC and Monster hp where the action input decides which of the chains are selected.

A few additional assumptions must be made to restrict the problem to a markov chain implementation:
\begin{itemize}
    \item The monster and pc hp will be restricted to a finite range, $x_{pc,hp},x_{mn,hp} \in \mathcal{X}_{hp} = \{0,1,\dots, n_{hp,max}\}$
    \item The ensuring of a potion will be a restriction upon the pc input/result in a nothing action if no potion is available.
    \item The deterministic movement will allow for monster action selection within closed-loop, however this splits the actual markov chain in two.
    \item The actual implimentation will keep the pc and monster hp independent of one another with actions being applied to the appropriate hp according to the action; however a proper markov chain would incorporate both into the states.
\end{itemize}

The states of the markov chain will be artificially independent $x_{pc,k}, x_{mn,k} = P(x_{pc,hp}), _(x_{mn,hp}) \in [0,1]^{n_{hp,max}+1}$.
The transition matrices will be defined as $[p_{i,j}] = P(x_{k+1} = i, x_{k} = j)$.
This can be thought of as each column being the probabilistic function results for $f(x_k,w_k), x_{k} = j, w_k = P[w_k]$. \todo{Improve notation of this terrible thing...}

\subsubsection{PC Actions}
First for the pc actions, which will be done independently from the monsters action which is then applied after according to the position.

When $u_k = \text{Melee}$, the $f(x_k,w_k)$ will act upon $x_{mn,hp}$ with uncertainty $w_k \in \mathcal{W}_{d6}$, resulting in$
    f(x_{k+1} = i \st x_{k}=j) = j - w_{pc,melee,sf}*(2+w_{pc,d6}) = j - P(w_{pc,melee,sf}=\smqty[0\\1])\cross (2+w_{pc,d6}P(w_{pc,d6}=\smqty[1&\cdots&6])) = j - \smqty[0.45\\0.55] \cross (2+w_{pc,d6}\smqty[1/6& \cdots & 1/6]^T)
$\todo{Notation terrible}
resulting in $P(x_{k+1} = j) = 0.45$, $P(x_{k+1} = j-2-1) = \cdots = P(x_{k+1} = j-2-6) = \frac{0.55}{6} = \frac{11}{120} \approx 0.01967$.
This is incorporated into the markov chain as the column $j$ has \[
    \mqty{i=1 \\ \vdots \\ i=j-2-7 \\ i=j-2-6\\ \vdots i = j-2-1 \\ i = j-2\\ i= j-1 \\ i=j \\ i=j+1\\ \vdots} \mqty [0\\ \vdots \\ 0\\ 0.019677\\ \vdots \\ 0.01967 \\ 0\\ 0 \\ 0.45 \\ 0 \\ \vdots ]
\]
and the first few columns will have all the probabilities of negative values summed into the zero row.
The markov chain transition matrix will be denoted as $P_{pc,melee}$.
\todo{confirm this direction... is this $P$ or $P^T$?}

Essentially the same definition is true with $u_k = \text{ranged}$ but with $w_{i,d8}$ and resulting in $P(x_{k+1} = j) = 0.45$, $P(x_{k+1} = j-2-1) = \cdots = P(x_{k+1} = j-2-8) = \frac{0.55}{8} = \frac{11}{160} = 0.06875$ and denoted with markov chain transition matrix $P_{pc,ranged}$.

Similarly for $u_k = \text{heal}$ but with $w_{i,d4}$ and not having the $w_{sf}$, meaning $P(x_{k+1} = j+1+1) = \cdots = P(x_{k+1} = j+1+4) = 1/4 = 0.25$ and denoted with markov chain transition matrix $P_{pc,heal}$.

Finally, for $u_k = \text{nothing}$ the transition matrix is defined as the identity matrix: $P_{pc,nothing} = \vb{I}_{n_{hp,max}}$

\subsubsection{Monster Movement and Actions}
For the simplistic case the movement is done first deterministically and then the monster actions are performed using the markov chains.
Selection between the actions would be done deterministically based on position after movement and then the action is the same transition matrix for melee $P_{mn,melee}$, ranged $P_{mn,ranged}$, and nothing $P_{mn,nothing}$ are equivelent to the PC's transition matrices as $P_{pc,melee}$, $P_{pc,ranged}$, and $P_{pc,nothing}$ respectively.

The movement is done as described in the problem definition: $x_{k+1,mn,p} = x_{k,mn,p} + \operatorname{direction}(x_{k+1,pc,p} - x_{k,mn,p})$.

The deterministic action input results in the monsters action being applied \[
    P_{mn} = \begin{cases}
        P_{mn,melee} & \norm{x_{pc,p} - x_{mn,p}}_1 \leq \text{Melee Range}\\
        P_{mn,ranged} & \text{Melee Range} < \norm{x_{pc,p} - x_{mn,p}}_1 \leq \text{Ranged Range}\\
        P_{mn,nothing} & \text{Ranged Range} < \norm{x_{pc,p} - x_{mn,p}}_1
    \end{cases}
\] where each will act upon the PC hp.

\subsubsection{Closed-loop Markov Chain}
The actual markov chains associated with closed-loop will be selected directly based on state and player input by selecting the appropriate markov chains.

Since the assumption that $u_k$ will be limited to those feasible by the PC, the following described as follows:

First, PC movement: $x_{k+1,pc,p} = x_{k,pc,p} + u_{pc,m}$.
\todo{being able to move after certaintly would add a lot more capability to the player's actions... however this would absolutely complicate it more...}

Second, PC action: \[
    \mqty[x_{k+1,pc,hp}\\ x_{k+1,mn,hp}] = \begin{cases}
        \mqty[x_{k,pc,hp}\\x_{k,mn,hp}^T P_{pc,melee}] & u_k = \text{melee}\\
        \mqty[x_{k,pc,hp}\\x_{k,mn,hp}^T P_{pc,ranged}] & u_k = \text{ranged}\\
        \mqty[x_{k,pc,hp}^T P_{pc,heal}\\ x_{k,mn,hp}] & u_k = \text{heal}\\
        \mqty[x_{k,pc,hp}\\x_{k,mn,hp}] & u_k = \text{nothing}
    \end{cases}
\]

Third, monster movement: $x_{k+1,mn,p} = x_{k,mn,p} + \operatorname{direction}(x_{k+1,pc,p} - x_{k,mn,p})$.

Finally, monster action:\[
    x_{k+1,pc,hp} = \begin{cases}
        x_{k,pc,hp}^T P_{mn,melee}  & \norm{x_{k+1,pc,p} - x_{k+1,mn,p}}_1 \leq \text{Melee Range}\\
        x_{k,pc,hp}^T P_{mn,ranged} & \text{Melee Range} < \norm{x_{k+1,pc,p} - x_{k+1,mn,p}}_1 \leq \text{Ranged Range}\\
        x_{k,pc,hp} & \text{Ranged Range} < \norm{x_{k+1,pc,p} - x_{k+1,mn,p}}_1
    \end{cases}
\]

It is possible to incorporate this into a single set of markov chains in higher dimensions; however, this sequential definition seems to make the most sense instead of defining a finite number of position states and closing the loop entirely.













% Appendix ----------------------------------------------
% \newpage
% \appendix
% \bibliographystyle{plain}
% \bibliography{refs.bib}




\end{document}
